name: Validate UoFA Examples

on:
  push:
  pull_request:
  schedule:
    - cron: "0 6 * * 1"  # Mondays 06:00 UTC

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema pyld pyshacl rdflib

      # Validate with JSON Schema (optional dev profile) + JSON-LD compaction
      - name: JSON / JSON-LD validation
        shell: python
        run: |
          import glob, json, sys, os
          from pathlib import Path
          from pyld import jsonld

          schema_path = Path("spec/context/v0.1.jsonld")
          do_schema = schema_path.exists()
          if do_schema:
              from jsonschema import Draft202012Validator
              schema = json.loads(schema_path.read_text())

          files = sorted(glob.glob("examples/*.json")) + sorted(glob.glob("examples/*.jsonld"))
          if not files:
              print("No example files found in /examples", file=sys.stderr)
              sys.exit(1)

          failures = 0
          for f in files:
              print(f"\n=== {f} ===")
              try:
                  data = json.loads(Path(f).read_text())
              except Exception as e:
                  print(f"✖ JSON parse error: {e}")
                  failures += 1
                  continue

              if do_schema:
                  try:
                      Draft202012Validator(schema).validate(data)
                      print("✔ JSON Schema profile OK")
                  except Exception as e:
                      print(f"✖ JSON Schema validation failed: {e}")
                      failures += 1
                      continue

              try:
                  compact = jsonld.compact(data, "https://uofa.net/context/v0.1")
                  assert "@context" in compact
                  print("✔ JSON-LD compaction OK (context v0.1)")
              except Exception as e:
                  print(f"✖ JSON-LD compaction failed: {e}")
                  failures += 1

          if failures:
              print(f"\nFailures: {failures}")
              sys.exit(1)
          print("\nAll examples passed basic checks.")

      # SHACL semantic validation (only if shape is present)
      - name: SHACL validation (if shapes exist)
        if: ${{ hashFiles('schemas/uofa.shacl.ttl') != '' }}
        shell: python
        run: |
          import glob, json, sys
          from pathlib import Path
          from rdflib import Graph
          from pyld import jsonld
          from pyshacl import validate

          shapes_file = Path("schemas/uofa.shacl.ttl")
          shapes_g = Graph().parse(shapes_file.read_text(), format="turtle")

          files = sorted(glob.glob("examples/*.json")) + sorted(glob.glob("examples/*.jsonld"))
          failures = 0
          for f in files:
              print(f"\n=== SHACL: {f} ===")
              try:
                  doc = json.loads(Path(f).read_text())
                  expanded = jsonld.expand(doc)
                  g = Graph().parse(data=json.dumps(expanded), format="json-ld")
                  ok, r, txt = validate(g, shacl_graph=shapes_g, inference='rdfs', debug=False)
                  if ok:
                      print("✔ SHACL conforms")
                  else:
                      print("✖ SHACL non-conformance")
                      print(txt)
                      failures += 1
              except Exception as e:
                  print(f"✖ SHACL step failed: {e}")
                  failures += 1

          if failures:
              print(f"\nSHACL failures: {failures}")
              sys.exit(1)
          print("\nAll examples conform to SHACL.")

      - name: Comment summary on PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              "✅ UoFA validation ran:",
              "- JSON/Schema layer (if schema present): OK",
              "- JSON-LD compaction against context v0.1: OK",
              "- SHACL (if shape present): see job logs"
            ].join("\n");
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            })
