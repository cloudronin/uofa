name: Validate UoFA Examples

on:
  push:
  pull_request:
  schedule:
    - cron: "0 6 * * 1"  # Mondays 06:00 UTC

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema pyld pyshacl rdflib

      - name: Find example files
        id: ls
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(examples/*.json examples/*.jsonld)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No example files found in /examples"; exit 1
          fi
          printf "%s\n" "${files[@]}" > files.txt
          echo "count=${#files[@]}" >> "$GITHUB_OUTPUT"

      - name: Validate (JSON Schema + JSON-LD)
        shell: bash
        run: |
          set -euo pipefail
          SCHEMA="schema/v0.1.jsonld"          # Developer-friendly JSON Schema (optional)
          CONTEXT_URL="https://uofa.net/context/v0.1"
          while read -r f; do
            echo "::group::Validating $f"

            # 1) JSON Schema (optional dev profile)
            if [ -f "$SCHEMA" ]; then
python - <<'PY'
import json, sys
from jsonschema import Draft202012Validator

schema = json.load(open("schemas/v0.1.jsonld"))
data   = json.load(open(sys.argv[1]))
Draft202012Validator(schema).validate(data)
print("✔ JSON Schema profile OK")
PY
python - "$f"
            else
              echo "ℹ No JSON Schema profile present, skipping schema check."
            fi

            # 2) JSON-LD compaction against context v0.1
python - <<'PY'
import json, sys
from pyld import jsonld
doc = json.load(open(sys.argv[1]))
compact = jsonld.compact(doc, "https://uofa.net/context/v0.1")
assert "@context" in compact, "Context did not compact properly"
print("✔ JSON-LD compaction OK (context v0.1)")
PY
python - "$f"

            echo "::endgroup::"
          done < files.txt

      - name: SHACL validation (if shapes exist)
        if: ${{ hashFiles('spec/context/uofa.shacl.ttl') != '' }}
        run: |
          set -euo pipefail
python - <<'PY'
from pyshacl import validate
from rdflib import Graph
import glob, json
from pyld import jsonld

# Load shape
shapes_g = Graph().parse("spec/context/uofa.shacl.ttl", format="turtle")

ok_all = True
for f in glob.glob("examples/*.json") + glob.glob("examples/*.jsonld"):
    doc = json.load(open(f))
    expanded = jsonld.expand(doc)           # JSON-LD → RDF
    g = Graph().parse(data=json.dumps(expanded), format="json-ld")
    ok, r, txt = validate(g, shacl_graph=shapes_g, inference='rdfs', debug=False)
    print(("✔" if ok else "✖") + " SHACL:", f)
    if not ok:
        print(txt)
        ok_all = False

if not ok_all:
    raise SystemExit(1)
PY

      - name: Summarize results in PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const summary = [
              "✅ UoFA validation ran on examples.",
              "",
              "- JSON/Schema layer: OK if profile present",
              "- JSON-LD compaction against context v0.1: OK",
              "- SHACL (if shape present): see logs"
            ].join("\n");
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            })
